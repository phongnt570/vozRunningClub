{% extends "base.html" %}
{% load humanize %}
{% load tz %}
{% load track_custom_utils %}

{% block pagetitle %}Voz Running Club{% endblock %}

{% block body %}
    <div class="container my-4">
        <div class="row mb-4">
            <div class="col-md-6">
                <div>
                    <h4>Leaderboard
                        {% if is_this_week %}
                            (this week)
                        {% elif is_last_week %}
                            (last week)
                        {% else %}
                            ({{ requested_week_start }} - {{ requested_week_end }})
                        {% endif %}
                    </h4>
                    <p>
                        {% get_current_timezone as TIME_ZONE %}
                        {% timezone TIME_ZONE %}
                            <span class="text-secondary">
                                <span>Last updated:</span>
                                <span>
                                    {% if is_last_week or is_this_week %}
                                        {{ last_updated|naturaltime }}
                                        (automatically updated every 10 minutes)
                                    {% else %}
                                        {{ last_updated }} ({{ TIME_ZONE }})
                                    {% endif %}
                                </span>
                            </span>
                        {% endtimezone %}
                        {% if request.user.is_authenticated %}
                            {% if is_last_week or is_this_week %}
                                (<span class="text-decoration-underline text-primary"
                                       onclick="updateLeaderboard()"
                                       role="button">Update now</span>, acting as
                                <span class="text-secondary">
                                {{ request.user.username }}</span>)
                            {% endif %}
                        {% endif %}
                    </p>
                </div>
            </div>
            <div class="col-md-6 d-flex justify-content-end"> 
                <div class="join-panel" id="join-panel">
                    <h4>Sign Up Here!</h4>
                    <p>If you want to join with us, then click to <em>Connect with STRAVA</em>.</p>
                    <div style="text-align:center"><a href="/profile/"><img src="/static/img/connect-strava.png" alt="Connect with STRAVA"></a></div>
                </div>
            </div>
        </div>
        

        <div class="mb-4">
            <select id="select-week" class="form-select" aria-label="Select week" onchange="changeWeek()">
                {% for key, value in available_weeks.items %}
                    {% if key.0 == requested_year and key.1 == requested_week_num %}
                        <option value="{{ key.0 }}-{{ key.1 }}" selected>{{ value }}</option>
                    {% else %}
                        <option value="{{ key.0 }}-{{ key.1 }}">{{ value }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pills-all-runners-tab" data-bs-toggle="pill"
                        data-bs-target="#all-runners-leaderboard"
                        type="button" role="tab" aria-controls="all-runners-leaderboard" aria-selected="true">
                    All runners ({{ requested_week_data|length }})
                </button>
            </li>
            {% for reg_dis, data in reg_map.items %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pills-{{ reg_dis }}-km-runners-tab" data-bs-toggle="pill"
                            data-bs-target="#{{ reg_dis }}-km-runners-leaderboard"
                            type="button" role="tab" aria-controls="{{ reg_dis }}-km-runners-leaderboard"
                            aria-selected="false">
                        {% if reg_dis == 0 %}
                            Not registered
                        {% else %}
                            {{ reg_dis }} km
                        {% endif %}
                        ({{ data|length }})
                    </button>
                </li>
            {% endfor %}
        </ul>
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="all-runners-leaderboard" role="tabpanel"
                 aria-labelledby="pills-all-runners-tab"
                 tabindex="0">
                {% include "weeklyTracking/leaderboard_table.html" with data=requested_week_data %}
            </div>
            {% for reg_dis, data in reg_map.items %}
                <div class="tab-pane fade" id="{{ reg_dis }}-km-runners-leaderboard" role="tabpanel"
                     aria-labelledby="pills-{{ reg_dis }}-km-runners-tab"
                     tabindex="0">
                    {% include "weeklyTracking/leaderboard_table.html" with data=data %}
                </div>
            {% endfor %}
        </div>
    </div>
    {% csrf_token %}

    <div id="spinner-wrapper" class="d-none">
        <div class="loading">Loading&#8230;</div>
    </div>

    <script>
        if(localStorage.getItem("token")){
            $("#join-panel").hide();
        }
        
        function changeWeek() {
            let selectedWeek = document.getElementById("select-week").value;
            let newYear = selectedWeek.split("-")[0];
            let newWeekNum = selectedWeek.split("-")[1];
            location.replace("{% url 'leaderboard' %}?year=" + newYear + "&week=" + newWeekNum);
        }

        function showSpinner() {
            document.getElementById("spinner-wrapper").classList.remove("d-none");
        }

        function hideSpinner() {
            document.getElementById("spinner-wrapper").classList.add("d-none");
        }
    </script>
    {% if request.user.is_authenticated %}
        <script>
          
            axios.defaults.xsrfCookieName = 'csrftoken';
            axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";

            async function updateLeaderboard() {
                showSpinner();
                await axios.post("{% url 'update-leaderboard' %}")
                    .then(function (response) {
                        if (response.data.status === "success") {
                            location.reload();
                        } else {
                            alert("Error updating leaderboard: " + response.data.message);
                            hideSpinner();
                        }
                    })
                    .catch(function (error) {
                        alert("Error updating leaderboard: " + error);
                        hideSpinner();
                    });
            }
        </script>
    {% endif %}
{% endblock %}